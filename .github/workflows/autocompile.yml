name: Build

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  CARGO_TERM_COLOR: always

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: nightly
        override: true
        components: rustfmt, clippy
    
    - name: Rust Cache
      uses: Swatinem/rust-cache@v2
      with:
        cache-on-failure: true
    
    - name: Build
      run: cargo build --release --verbose
    
    - name: Run tests
      run: cargo test --verbose
    
    - name: Get version from Cargo.toml
      id: cargo_version
      run: |
        $version = (Select-String -Path Cargo.toml -Pattern '^version = "(.*)"').Matches.Groups[1].Value
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        echo "Version found: $version"
      shell: pwsh
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: windows-executable
        path: target/release/*.exe
        retention-days: 30
        
  create-release:
    needs: build-windows
    runs-on: ubuntu-latest
    # –¢–æ–ª—å–∫–æ –ø—Ä–∏ –ø—É—à–µ –≤ main (–Ω–µ –ø—Ä–∏ PR)
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Get version from Cargo.toml
      id: cargo_version
      run: |
        VERSION=$(grep "^version" Cargo.toml | sed 's/version = "\(.*\)"/\1/')
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "Version found: $VERSION"
    
    - name: Check if release exists
      id: check_release
      run: |
        if gh release view "v${{ steps.cargo_version.outputs.VERSION }}" >/dev/null 2>&1; then
          echo "EXISTS=true" >> $GITHUB_OUTPUT
          echo "Release v${{ steps.cargo_version.outputs.VERSION }} already exists, skipping"
        else
          echo "EXISTS=false" >> $GITHUB_OUTPUT
          echo "Will create release v${{ steps.cargo_version.outputs.VERSION }}"
        fi
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Get previous tag
      if: steps.check_release.outputs.EXISTS == 'false'
      id: prev_tag
      run: |
        # –ü–æ–ª—É—á–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–µ–≥
        PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
        echo "PREV_TAG=$PREV_TAG" >> $GITHUB_OUTPUT
        if [ -z "$PREV_TAG" ]; then
          echo "No previous tag found, will include all commits"
        else
          echo "Previous tag: $PREV_TAG"
        fi
    
    - name: Generate changelog
      if: steps.check_release.outputs.EXISTS == 'false'
      id: changelog
      run: |
        echo "Generating changelog..."
        
        # –°–æ–∑–¥–∞—ë–º —Ñ–∞–π–ª –¥–ª—è changelog
        echo "" > changelog.md
        
        # –ï—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–µ–≥, –ø–æ–ª—É—á–∞–µ–º –∫–æ–º–º–∏—Ç—ã –ø–æ—Å–ª–µ –Ω–µ–≥–æ
        if [ -n "${{ steps.prev_tag.outputs.PREV_TAG }}" ]; then
          echo "## üìã Changes since ${{ steps.prev_tag.outputs.PREV_TAG }}" >> changelog.md
          echo "" >> changelog.md
          
          # –ü–æ–ª—É—á–∞–µ–º –∫–æ–º–º–∏—Ç—ã –º–µ–∂–¥—É —Ç–µ–≥–∞–º–∏
          git log ${{ steps.prev_tag.outputs.PREV_TAG }}..HEAD --pretty=format:"- %s ([%h](https://github.com/${{ github.repository }}/commit/%H)) by @%an" --no-merges >> changelog.md
        else
          echo "## üìã All Changes" >> changelog.md
          echo "" >> changelog.md
          
          # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∫–æ–º–º–∏—Ç—ã
          git log --pretty=format:"- %s ([%h](https://github.com/${{ github.repository }}/commit/%H)) by @%an" --no-merges >> changelog.md
        fi
        
        echo "" >> changelog.md
        echo "" >> changelog.md
        
        # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –∫–æ–º–º–∏—Ç—ã –ø–æ —Ç–∏–ø–∞–º (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ conventional commits)
        echo "## üìä Commit Statistics" >> changelog.md
        echo "" >> changelog.md
        
        if [ -n "${{ steps.prev_tag.outputs.PREV_TAG }}" ]; then
          COMMIT_COUNT=$(git rev-list --count ${{ steps.prev_tag.outputs.PREV_TAG }}..HEAD)
          CONTRIBUTORS=$(git log ${{ steps.prev_tag.outputs.PREV_TAG }}..HEAD --pretty=format:"%an" | sort -u | wc -l)
        else
          COMMIT_COUNT=$(git rev-list --count HEAD)
          CONTRIBUTORS=$(git log --pretty=format:"%an" | sort -u | wc -l)
        fi
        
        echo "- Total commits: $COMMIT_COUNT" >> changelog.md
        echo "- Contributors: $CONTRIBUTORS" >> changelog.md
        echo "" >> changelog.md
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º changelog –≤ output
        echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
        cat changelog.md >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤ –ª–æ–≥–∞—Ö
        echo "Generated changelog:"
        cat changelog.md
    
    - name: Download artifact
      if: steps.check_release.outputs.EXISTS == 'false'
      uses: actions/download-artifact@v4
      with:
        name: windows-executable
        path: ./artifacts
    
    - name: Create source archives
      if: steps.check_release.outputs.EXISTS == 'false'
      run: |
        mkdir release
        cp -r artifacts/* release/
        # –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º exe —Ñ–∞–π–ª—ã, –¥–æ–±–∞–≤–ª—è—è –≤–µ—Ä—Å–∏—é
        cd release
        for file in *.exe; do
          if [ -f "$file" ]; then
            name="${file%.exe}"
            mv "$file" "${name}-v${{ steps.cargo_version.outputs.VERSION }}.exe"
          fi
        done
        cd ..
        # –°–æ–∑–¥–∞—ë–º –∞—Ä—Ö–∏–≤—ã –∏—Å—Ö–æ–¥–Ω–∏–∫–æ–≤
        git archive --format=zip --output=release/source-v${{ steps.cargo_version.outputs.VERSION }}.zip HEAD
        git archive --format=tar.gz --output=release/source-v${{ steps.cargo_version.outputs.VERSION }}.tar.gz HEAD
    
    - name: Create Draft Release
      if: steps.check_release.outputs.EXISTS == 'false'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.cargo_version.outputs.VERSION }}
        name: Release v${{ steps.cargo_version.outputs.VERSION }}
        body: |
          <!-- –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —ç—Ç–æ –æ–ø–∏—Å–∞–Ω–∏–µ –ø–µ—Ä–µ–¥ –ø—É–±–ª–∏–∫–∞—Ü–∏–µ–π -->
          
          ## üéâ Release v${{ steps.cargo_version.outputs.VERSION }}
          
          _–î–æ–±–∞–≤—å—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –∑–¥–µ—Å—å –ø–µ—Ä–µ–¥ –ø—É–±–ª–∏–∫–∞—Ü–∏–µ–π..._
          
          ---
          
          ${{ steps.changelog.outputs.CHANGELOG }}
          
          ---
          
          ## üì¶ Downloads
          
          ### Windows
          - **Windows executable** - Pre-built binary for Windows (x86_64)
          
          ### Source Code
          - **Source code (zip)** - Complete source code in ZIP format
          - **Source code (tar.gz)** - Complete source code in TAR.GZ format
          
          ---
          
          ## üìù Installation
          
          ### Windows
          1. Download the `.exe` file
          2. Place it in your desired directory
          3. Run from command line or double-click
          
          ### Build from source
          ```bash
          cargo build --release
          ```
          
          ---
          
          ## üîó Links
          
          - [Documentation](https://github.com/${{ github.repository }}/blob/main/README.md)
          - [Issues](https://github.com/${{ github.repository }}/issues)
          - [Discussions](https://github.com/${{ github.repository }}/discussions)
        files: |
          release/*
        generate_release_notes: false  # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–≤–æ–π changelog
        draft: true  # –í—Å–µ–≥–¥–∞ —Å–æ–∑–¥–∞—ë–º –∫–∞–∫ —á–µ—Ä–Ω–æ–≤–∏–∫
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
